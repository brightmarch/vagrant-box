---
- name: install php-imagick dependencies
  apt: name={{ item }} state=present
  with_items:
    - imagemagick
    - libmagickwand-dev
    - libmagickcore-dev

- name: create destination for source
  file: path={{ php_imagick_source_dir }} state=directory

- name: download php-imagick tarball
  get_url: url={{ php_imagick_source }} dest={{ php_imagick_source_dir }}

- name: unpack php-imagick source
  unarchive: src={{ php_imagick_source_path }} dest={{ php_imagick_source_dir }} copy=no
    creates={{ php_imagick_source_dir + php_imagick_dir }}

- name: install php-imagick
  shell: '{{ item }} chdir={{ php_imagick_source_dir + php_imagick_dir }}
      creates={{ php_imagick_source_dir + php_imagick_dir }}/modules/imagick.so'
  with_items:
    - phpize
    - ./configure
    - make && make install  # Make this a one-liner so we can use the 
                            # modules/imagick.so to check that it has already
                            # executed. That file is created during make not
                            # make install.

- name: add imagick to php.ini
  lineinfile: dest=/usr/local/lib/php.ini line="extension=imagick.so"
